# Telegram Emoji Casino

> Aiogram‚ÄØ3 + FastAPI backend, Redis, Postgres, Next.js Mini App for slot/duel/crash gameplay with double‚Äëwallet economy (cash + bonus coins), WR tracking, gifts, referrals, and analytics hooks.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ü–æ—á–µ–º—É —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç](#–ø–æ—á–µ–º—É-—ç—Ç–æ—Ç-–ø—Ä–æ–µ–∫—Ç)
2. [–ë–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–∞ –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å](#–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞-–∏-—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è-–º–æ–¥–µ–ª—å)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
4. [–ë—ç–∫–µ–Ω–¥](#–±—ç–∫–µ–Ω–¥)
   - [–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö](#–º–æ–¥–µ–ª–∏-–¥–∞–Ω–Ω—ã—Ö)
   - [–ö–æ—à–µ–ª—å–∫–∏ –∏ –±–æ–Ω—É—Å—ã](#–∫–æ—à–µ–ª—å–∫–∏-–∏-–±–æ–Ω—É—Å—ã)
   - [Crash‚Äë—Å–µ—Ä–≤–∏—Å](#crash-—Å–µ—Ä–≤–∏—Å)
   - [–ë–æ—Ç—ã –∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã](#–±–æ—Ç—ã-–∏-—Ö–µ–Ω–¥–ª–µ—Ä—ã)
5. [HTTP API –∏ WebSocket](#http-api-–∏-websocket)
6. [Crash Mini App (Next.js)](#crash-mini-app-nextjs)
7. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-–∏-–∑–∞–ø—É—Å–∫)
8. [–¢–µ—Å—Ç—ã](#—Ç–µ—Å—Ç—ã)
9. [–ü–ª–∞–Ω—ã](#–ø–ª–∞–Ω—ã)

---

## –ü–æ—á–µ–º—É —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç
–¢–µ–ª–µ–≥—Ä–∞–º‚Äë–±–æ—Ç ¬´Emoji Casino¬ª —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–≥—Ä–æ–≤—ã–µ —Ä–µ–∂–∏–º—ã (—Å–ª–æ—Ç, –¥—É—ç–ª–∏, crash) –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–∞–≤–∏–ª Telegram Stars: –Ω–µ—Ç –≤—ã–ø–ª–∞—Ç Stars –Ω–∞–∑–∞–¥, –µ—Å—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞ (coins_cash / coins_bonus) –∏ –ø–æ–¥–∞—Ä–∫–∏. –ë–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–∞ –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Å–∞–Ω–∞ –≤ `docs` —Ä–∞–∑–¥–µ–ª–∞—Ö —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Å–º. –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è).

–û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ß–µ—Å—Ç–Ω—ã–π —Å–ª–æ—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (`sendDice(üé∞)`) –∏ crash —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º seed‚Äô–æ–º.
- –≠–∫–æ–Ω–æ–º–∏–∫–∞ —Å –¥–≤—É–º—è –∫–æ—à–µ–ª—å–∫–∞–º–∏ (cash –∏ bonus), WR, –ª–∏–º–∏—Ç–∞–º–∏ —Å—Ç–∞–≤–æ–∫.
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–∞—Ä—Ç–Ω—ë—Ä–∫–∞, –ø–æ–¥–∞—Ä–∫–∏ –∑–∞ –±–æ–Ω—É—Å—ã, –¥–µ–ø–æ–∑–∏—Ç–Ω—ã–µ –±–æ–Ω—É—Å—ã.
- Crash Mini App —Å JWT‚Äë–∑–∞—â–∏—â—ë–Ω–Ω—ã–º REST/WS‚ÄëAPI.

## –ë–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–∞ –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å
1. **–ö–æ—à–µ–ª—å–∫–∏** (`wallets`):
   - `coins_cash`: –ø–æ–∫—É–ø–∞–µ—Ç—Å—è –∑–∞ Stars, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å—Ç–∞–≤–æ–∫, –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–∑–æ–º/–∞–Ω–ª–æ–∫–æ–º –±–æ–Ω—É—Å–æ–≤.
   - `coins_bonus`: –±–æ–Ω—É—Å–Ω–∞—è –≤–∞–ª—é—Ç–∞ (welcome, –¥–µ–ø–æ–∑–∏—Ç, —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞). –¢—Ä–∞—Ç–∏—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º WR. –ê–Ω–ª–æ–∫ ‚Üí –ø–µ—Ä–µ–Ω–æ—Å –≤ cash.
2. **–ë–æ–Ω—É—Å—ã** (`bonus_awards`):
   - `create_bonus_award` —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å, –∑–∞—á–∏—Å–ª—è–µ—Ç –±–æ–Ω—É—Å—ã –≤ –∫–æ—à–µ–ª—ë–∫.
   - `apply_turnover(game, stake)` –æ–±–Ω–æ–≤–ª—è–µ—Ç `turnover_progress` –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏–∑ `turnover_rules` (slot 100%, crash 50%, duel 25%).
   - `try_unlock_bonuses` –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ WR –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –æ—Å—Ç–∞—Ç–æ–∫ –≤ `coins_cash`, —Å–æ–∑–¥–∞–µ—Ç ledger –∑–∞–ø–∏—Å–∏.
3. **–°–ª–æ—Ç**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `sendDice("üé∞")`, —Ç–∞–±–ª–∏—Ü–∞ –≤—ã–ø–ª–∞—Ç –ª–µ–∂–∏—Ç –≤ `configs/payouts.json`, –∑–∞–≥—Ä—É–∑—á–∏–∫ `apps/bot/core/slot_payouts.py`.
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –±–æ–Ω—É—Å–µ (`bonus_bet_limit`).
4. **–î—É—ç–ª–∏** (`apps/bot/handlers/duels.py`):
   - –í–∑–Ω–æ—Å –±–æ–Ω—É—Å–∞–º–∏ –∏–ª–∏ cash, BO3, –±–∞–Ω–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ —Å—É–º–º–∞—Ä–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫.
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: 1 –∞–∫—Ç–∏–≤–Ω–∞—è –¥—É—ç–ª—å, ‚â§3 –¥—É—ç–ª–µ–π –æ–¥–Ω–æ–π –ø–∞—Ä—ã –≤ —Å—É—Ç–∫–∏.
5. **–ü–æ–¥–∞—Ä–∫–∏ –∏ –∫–∞–∑–Ω–∞** (`apps/bot/services/gifts.py`):
   - –õ–∏–º–∏—Ç—ã –ø–æ `TREASURY_XTR_START`, `GIFTS_BUDGET_XTR_DAY`, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ –æ—Ç—ã–≥—Ä—ã—à–∞ –±–æ–Ω—É—Å–æ–≤.
   - –û—á–µ—Ä–µ–¥—å –∑–∞—è–≤–æ–∫ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ XTR.
6. **Crash** (–æ–ø–∏—Å–∞–Ω–æ –Ω–∏–∂–µ).

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
[Telegram User] --(Bot API/Payments)--> [Aiogram + FastAPI] <---> [Postgres]
        |                                                       |
        |----Mini App (WebApp)---- JWT ----> [FastAPI / Crash WS]
```
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- `apps/bot`: Aiogram‚Äë–±–æ—Ç –∏ REST API (FastAPI). –†–∞–±–æ—Ç–∞–µ—Ç –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ, –µ—Å—Ç—å health/metrics.
- `apps/crash`: Next.js 15, Zustand, Telegram SDK. –ú–∏–Ω–∏‚Äë–∞–ø–ø —Å –∫–∞–Ω–≤–æ–π/Phaser‚Äë–∏–≥—Ä–æ–π.
- `alembic`: –º–∏–≥—Ä–∞—Ü–∏–∏ Postgres 16.
- Redis –¥–ª—è FSM/slot state/ rate limiting.

## –ë—ç–∫–µ–Ω–¥

### –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (`apps/bot/db/models.py`)
- `User`, `Wallet`, `BonusAward`, `TurnoverRule`, `Spin`, `Duel`, `Gift`, `Referral`, `TreasuryState`.
- Crash: `CrashRound` (seed, hash, crash_point, bet/crash timestamps) –∏ `CrashBet` (amount_cash/bonus, auto_cashout, payout, status).
- Ledger (`Ledger`) —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –∫–∞–∂–¥–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤.

### –ö–æ—à–µ–ª—å–∫–∏ –∏ –±–æ–Ω—É—Å—ã (`apps/bot/core/wallets.py`, `apps/bot/core/awards.py`)
- `add_coins_cash`, `add_coins_bonus` ‚Äî –æ–±–Ω–æ–≤–ª—è—é—Ç –∫–æ—à–µ–ª—ë–∫ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π `FOR UPDATE`, –ø–∏—à—É—Ç –≤ `ledger`.
- `consume_coins(user_id, amount, prefer)` ‚Äî —Ç—Ä–∞—Ç–∏—Ç cash/bonus –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `WalletConsumption` (cash/bonus). –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç, –ø–∏—à–µ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ ledger –∑–∞–ø–∏—Å–∏.
- `apply_turnover` ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤–∫–ª–∞–¥ —Å—Ç–∞–≤–∫–∏ –∫ –∞–∫—Ç–∏–≤–Ω—ã–º `bonus_awards`, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ READY.
- `try_unlock_bonuses` ‚Äî –¥–ª—è READY –±–æ–Ω—É—Å–æ–≤ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç `coins_bonus` ‚Üí `coins_cash` (–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –ø–æ `cap_cashout`).

### Crash‚Äë—Å–µ—Ä–≤–∏—Å (`apps/bot/services/crash.py`)
–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `_create_round` ‚Äî –∑–∞–¥–∞—ë—Ç seed, hash, `bet_ends_at`, `crash_at`, `crash_point` (—á–µ—Ä–µ–∑ SHA256). –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞—É–Ω–¥–∞ –∏–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω.
- `_active_round` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Ä–∞—É–Ω–¥. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `_sync_round` –∏ `_settle_round`.
- `_sync_round` ‚Äî –ø–µ—Ä–µ–≤–æ–¥–∏—Ç BETTING ‚Üí FLYING (–∫–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–ª–∞ —Ñ–∞–∑–∞ —Å—Ç–∞–≤–æ–∫) –∏ FLYING ‚Üí CRASHED (–ø–æ –≤—Ä–µ–º–µ–Ω–∏). –ü–æ—Å–ª–µ CRASHED –≤—ã–∑—ã–≤–∞–µ—Ç `_settle_round`, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–º–µ—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –∫–∞–∫ CRASHED, –Ω–∞—á–∏—Å–ª—è–µ—Ç turnover.
- `get_state(user_id)` ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç —Å–Ω–∏–º–æ–∫ (`CrashSnapshot`): —Å–µ—Å—Å–∏—è, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–∞–ª–∞–Ω—Å.
- `place_bet(user)` ‚Äî –≤ BETTING —Ñ–∞–∑–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç coins (`consume_coins`, —Ä–µ–∂–∏–º `auto_bonus_when_active`), —Å–æ–∑–¥–∞—ë—Ç `CrashBet`, —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `user.paid_crash_bets_count`. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `CrashSnapshot`.
- `cashout(user)` ‚Äî –≤ FLYING —Ñ–∞–∑–µ —Å—á–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç –¥–æ `crash_point`), –Ω–∞—á–∏—Å–ª—è–µ—Ç payout (`add_coins_cash`), –æ–±–Ω–æ–≤–ª—è–µ—Ç `CrashBet` (status, multiplier, payout) –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç turnover.
- `get_round_summary()`, `get_recent_history()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è WS‚Äë—Å–µ—Ä–≤–µ—Ä–æ–º –¥–ª—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏ –∏—Å—Ç–æ—Ä–∏–∏.

### –ë–æ—Ç—ã –∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã (–æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
- `apps/bot/handlers/menu.py`: `/start`, `/profile`, inline‚Äë–º–µ–Ω—é, —Å–ª–æ—Ç (`load_slot_state`, `render_slot`, `handle_slot_bet/toggle`). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏ –∏ —Ä–µ–∂–∏–º–∞.
- `apps/bot/handlers/shop.py`: `/buy`, callback –Ω–∞ –≤—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞, `successful_payment` (Telegram Payments XTR) ‚Üí `record_purchase` + `add_coins_cash` + `create_bonus_award` + —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞ (`try_activate_referral`).
- `apps/bot/handlers/duels.py`: —Å–æ–∑–¥–∞–Ω–∏–µ –¥—É—ç–ª–∏, –ø—Ä–∏—ë–º, —Å–ø–∏—Å–∞–Ω–∏—è (`consume_coins`), –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ—ë–≤ (`sendDice`), —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∞–Ω–∫–∞, –≤–æ–∑–≤—Ä–∞—Ç—ã –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ.
- `apps/bot/handlers/gifts.py`: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤, –≤—ã–∑–æ–≤ `redeem_gift` (—Å–ø–∏—Å—ã–≤–∞–µ—Ç –±–æ–Ω—É—Å—ã, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∑–Ω—É).

## HTTP API –∏ WebSocket

### Auth (`/api/auth/telegram`)
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: tma <initData>`, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ `verify_telegram_init_data`, upsert –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
  ```json
  {
    "token": "<JWT>",
    "expires_in": 600,
    "user": { ... },
    "wallet": { "cash": 1000, "bonus": 500, "total": 1500 }
  }
  ```
- JWT HS256 (`CRASH_JWT_SECRET`, TTL=`CRASH_JWT_TTL`).

### Crash REST (`/api/crash/*`)
- `GET /state` ‚Äî —Ç–µ–∫—É—â–∏–π —Å–Ω–∏–º–æ–∫ —Å–µ—Å—Å–∏–∏ + –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç–∞–≤–∫–∏.
- `POST /bet { amount, auto_cashout? }` ‚Äî –≤ —Ñ–∞–∑–µ BETTING —Å–æ–∑–¥–∞—ë—Ç —Å—Ç–∞–≤–∫—É. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ —á–µ—Ä–µ–∑ WS‚Äë–º–µ–Ω–µ–¥–∂–µ—Ä (`bet-accepted`).
- `POST /cashout` ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å –∏ payout –≤ —Ñ–∞–∑–µ FLYING. WS‚Äë–º–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç—Å—ã–ª–∞–µ—Ç `cashout-processed`.
- –í—Å–µ —Ä–æ—É—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `HTTPBearer` + `decode_crash_jwt`, –ø—Ä–æ–≤–µ—Ä—è—é—Ç `User.banned`.

### Crash WebSocket (`/ws/crash`)
- –ü—Ä–æ—Ç–æ–∫–æ–ª:
  1. –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `{"type":"auth","token":"<JWT>"}`.
  2. –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç `auth-success`, –∑–∞—Ç–µ–º `sync` (—Å–Ω–∏–º–æ–∫ —Ä–∞—É–Ω–¥–∞), `balance-update`, `session-history` (–ø–æ—Å–ª–µ–¥–Ω–∏–µ crash‚Äë–ø–æ–∏–Ω—Ç—ã).
  3. –§–æ–Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –∫–∞–∂–¥—ã–µ ~1‚ÄØ—Å:
     - `game-start` (–Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥, seed_hash), `game-flying`, `game-crash` (—Å `seed` –∏ crash_point).
  4. –ü—Ä–∏ REST‚Äë–±–µ—Ç–∞—Ö/–∫—ç—à–∞—É—Ç–∞—Ö —Å–µ—Ä–≤–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç `notify_bet/notify_cashout`, –∫–æ—Ç–æ—Ä—ã–µ –ø—É—à–∞—Ç `bet-accepted`/`cashout-processed` + `balance-update` —Ç–æ–ª—å–∫–æ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
  5. –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ—Å—ã–ª–∞—Ç—å `{"type":"ping"}` ‚Üí –æ—Ç–≤–µ—Ç `pong`.

## Crash Mini App (Next.js)

### AuthProvider (`apps/crash/components/AuthProvider.tsx`)
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Telegram WebApp SDK (`init`, `retrieveRawInitData`).
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `initData` –Ω–∞ `/api/auth/telegram`, –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ JWT –≤ Zustand (`useStore`), —Ö—Ä–∞–Ω–∏—Ç –≤ `localStorage`.
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (`BlockedUserScreen`) –∏ –∑–∞–≥—Ä—É–∑–∫—É.

### Zustand Store (`apps/crash/lib/store.ts`)
- `user`, `balance`, `demoBalance`, `authToken`, `apiBaseUrl`.
- –ú–µ—Ç–æ–¥—ã `setUser`, `setBalance`, `adjustBalance`, `setAuthToken`.

### REST helper (`apps/crash/lib/crash.ts`)
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –æ—Ç–≤–µ—Ç—ã API (`CrashStateSnapshot`, `CrashActionResponse`), –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç `/state`, `/bet`, `/cashout`.

### CrashGameArea
- –¢—è–Ω–µ—Ç `initData`, JWT, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WebSocket (`useLobbySocket`), —Ö—Ä–∞–Ω–∏—Ç —Ñ–∞–∑—É/seed/start/crashPoint, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å REST/WS.
- `handlePlaceBet` / `handleCashout` –≤—ã–∑—ã–≤–∞—é—Ç `postCrashBet` / `postCrashCashout` –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –±–∞–ª–∞–Ω—Å/—Å—Ç–∞–≤–∫–∏.
- –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –∫–∞–Ω–≤—É (`PhaserGame`), –ø–∞–Ω–µ–ª—å —Å—Ç–∞–≤–æ–∫ (`CrashBetControls`), –∏—Å—Ç–æ—Ä–∏—é (`GameHistory`, `SessionHistory`, `TopRecords`). Landing (`app/page.tsx`) –≤—ã–≤–æ–¥–∏—Ç –∏–º–µ–Ω–Ω–æ CrashGameArea.

### WebSocket hook (`apps/crash/hooks/useLobbySocket.ts`)
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `auth`, —Ö—Ä–∞–Ω–∏—Ç `connected`, `user`, `lobbyEvents`, `sessionHistory`.
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π (lowercase, `:` ‚Üí `-`), –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `auth-success`, `game-*`, `bet-accepted`, `cashout-processed`, `balance-update`, `chat-message`.
- –í—ã–∑—ã–≤–∞–µ—Ç `setBalance` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `balance`/`wallet` payload.

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**:
   ```bash
   python3.11 -m pip install --user -e '.[dev]'
   cd apps/crash && npm install
   ```
2. **Postgres + Redis**: –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `docker-compose up -d`. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∑–∞–¥–∞—é—Ç—Å—è –≤ `.env` (—Å–º. –ø—Ä–∏–º–µ—Ä).
3. **–ú–∏–≥—Ä–∞—Ü–∏–∏**:
   ```bash
   alembic upgrade head
   ```
4. **–ó–∞–ø—É—Å–∫**:
   ```bash
   make dev            # uvicorn + aiogram
   cd apps/crash && npm run dev   # Mini App (–∏–ª–∏ npm run build/start –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
   ```
5. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** (–∫–ª—é—á–µ–≤—ã–µ):
   - `BOT_TOKEN_MAIN`, `BOT_TOKEN_TEST`
   - `DATABASE_URL`, `REDIS_URL`
   - `CRASH_JWT_SECRET` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
   - `CRASH_PUBLIC_URL`, `CRASH_WS_URL` ‚Äî –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞
   - –õ–∏–º–∏—Ç—ã: `CRASH_BET_MIN`, `CRASH_BET_MAX`, `CRASH_BET_DURATION_MS`, `CRASH_ROUND_DURATION_MS` –∏ —Ç.–¥.

## –¢–µ—Å—Ç—ã
–í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (`pytest-asyncio`):
```bash
python3.11 -m pytest
```
- `tests/test_wallets_awards.py` ‚Äî –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤, –±–æ–Ω—É—Å–æ–≤ –∏ WR.
- `tests/test_crash_service.py` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–≤–æ–∫ –∏ –∫—ç—à–∞—É—Ç–∞, —Å—Ç–∞—Ç—É—Å CrashBet, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞, paid_crash_bets_count.

## –ü–ª–∞–Ω—ã
- **Crash Step 4**: –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –º–µ—Ç—Ä–∏–∫–∞–º/ledger (—á–∞—Å—Ç–∏—á–Ω–æ –µ—Å—Ç—å), —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (`events`), UI –¥–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ Mini App.
- **WS —É–ª—É—á—à–µ–Ω–∏—è**: —á–∞—Ç, –æ–Ω–ª–∞–π–Ω‚Äë—Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è `balance-update` –¥–ª—è –≤—Å–µ—Ö.
- **–ê–¥–º–∏–Ω–∫–∞**: –º–æ–¥–µ—Ä–∞—Ü–∏—è crash —Å—Ç–∞–≤–æ–∫, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ seed‚Äô–∞–º–∏, –ø—Ä–æ—Å–º–æ—Ç—Ä WR –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

---

–ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –æ–ø–∏—Å–∞–Ω–Ω—É—é –≤ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫—É: –∫–æ—à–µ–ª—ë–∫ —Å –¥–≤—É–º—è –±–∞–ª–∞–Ω—Å–∞–º–∏, –∂—ë—Å—Ç–∫–∏–µ –ª–∏–º–∏—Ç—ã WR, –ø–æ–¥–∞—Ä–∫–∏ –ø–æ—Å–ª–µ –æ—Ç—ã–≥—Ä—ã—à–∞, crash Mini App —Å JWT‚Äë–∑–∞—â–∏—Ç–æ–π –∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏. README —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, —á—Ç–æ–±—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –±—ã–ª –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏—á–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
