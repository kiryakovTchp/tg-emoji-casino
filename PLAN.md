# Bugfix Plan

## 1. Починка обработчика слота
- Исправить структуру `try/except/finally` в `apps/bot/handlers/menu.py` внутри `handle_slot_spin`, чтобы файл компилировался.
- Перепроверить логику блокировки Redis и отправку событий после правок.

## 2. Добавление зависимости greenlet
- Внести `greenlet>=3.0` в `[project].dependencies` в `pyproject.toml`.
- Убедиться, что установка зависимостей и pytest проходят без ручной установки.

## 3. Поддержка auto cashout в Crash
- Реализовать автоматический кэшаут для активных ставок при достижении заданного множителя.
- Учитывать автоматический кэшаут в фоновой задаче или при синхронизации раунда.
- Обновить модели/события так, чтобы пользователь видел факт автокэшаута.
- Ввод автокоммита для HTTP/WS сессий, чтобы выплаты фиксировались.
- Очистка очереди auto cashout событий при обработке.

## 4. Валидация Telegram init data по времени
- В `apps/bot/core/security.py` проверять `auth_date` и отклонять init data старше заданного окна (например, 1 минута).
- Добавить тест/константу TTL и описать поведение в коде.

## 5. Очистка веб-сокет подключений Crash
- Поправить `_unregister` в `apps/bot/ws/crash.py`, чтобы удалять пустые наборы и не держать мёртвые подключения.
- По возможности добавить обработку ошибок рассылки (например, удалять упавшие сокеты).

## 6. Финальные проверки
- Запустить `pytest` после правок.
- Описать результаты и оставшиеся риски в ответе.
